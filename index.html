<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salary Tracker (Lite)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    .btn { margin: 4px; padding: 6px 10px; }
    details { margin-top: 20px; }
  </style>
</head>
<body>

  <h2>ğŸ’° Salary List</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th><th>ID</th><th>Initial</th><th>Paid</th><th>Remain</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <button id="addPersonBtn" class="btn">â• Add Person</button>
  <button id="refreshBtn" class="btn">ğŸ”„ Refresh</button>

  <details>
    <summary>âš™ï¸ Connection</summary>
    <label>Owner: <input id="ownerInput"></label><br>
    <label>Repo: <input id="repoInput"></label><br>
    <label>Branch: <input id="branchInput" value="main"></label><br>
    <label>Path: <input id="pathInput" value="payroll.json"></label><br>
    <label>Your Name: <input id="nameInput"></label><br>
    <label>Token: <input id="tokenInput" type="password"></label><br>
    <button id="connectBtn" class="btn">ğŸ”Œ Connect</button>
    <div id="status"></div>
  </details>

  <template id="rowTpl">
    <tr>
      <td class="name"></td>
      <td class="id"></td>
      <td class="initial"></td>
      <td class="paid"></td>
      <td class="remain"></td>
      <td>
        <button class="editBtn btn">âœï¸</button>
        <button class="payBtn btn">ğŸ’µ</button>
      </td>
    </tr>
  </template>

<script>
const $ = (s,el=document)=>el.querySelector(s);
const state = { data:{items:[],currency:'USD'}, sha:null };
let gh;

function uid(){ return Math.random().toString(36).slice(2,9); }
function fmt(n,c){ return (n||0).toLocaleString(undefined,{style:'currency',currency:c}); }
function calc(item){ const paid=(item.paid||[]).reduce((a,b)=>a+b.amount,0); return {paid,remain:item.initial-paid}; }

class GH {
  constructor(o,r,b,p,t){ this.o=o;this.r=r;this.b=b;this.p=p;this.t=t; }
  get api(){ return `https://api.github.com/repos/${this.o}/${this.r}/contents/${this.p}`; }
  async get(){ const res=await fetch(this.api+`?ref=${this.b}`,{headers:{Authorization:`token ${this.t}`}}); 
    if(!res.ok) throw new Error(res.status); const j=await res.json(); 
    return {sha:j.sha,content:JSON.parse(atob(j.content.replace(/\\n/g,'')))}; }
  async put(text,msg,sha){ 
    const res=await fetch(this.api,{method:'PUT',headers:{Authorization:`token ${this.t}`,'Content-Type':'application/json'}, 
      body:JSON.stringify({message:msg,branch:this.b,content:btoa(text),sha})}); 
    if(!res.ok) throw new Error(res.status); return await res.json(); }
}

async function connect(){
  try{
    const o=$('#ownerInput').value.trim(), r=$('#repoInput').value.trim();
    const b=$('#branchInput').value.trim(), p=$('#pathInput').value.trim();
    const n=$('#nameInput').value.trim(), t=$('#tokenInput').value.trim();
    state.yourName=n; gh=new GH(o,r,b,p,t);
    const {sha,content}=await gh.get(); state.sha=sha; state.data=content; render();
    $('#status').textContent='Connected âœ”';
  }catch(e){ $('#status').textContent='Connect error '+e.message; }
}

async function save(msg){
  try{
    const {sha}=await gh.put(JSON.stringify(state.data,null,2),msg,state.sha);
    state.sha=sha; $('#status').textContent='Saved âœ”';
  }catch(e){ alert('Save error '+e.message); }
}

function render(){
  const tb=$('#tbody'); tb.innerHTML='';
  state.data.items.forEach(item=>{
    const row=document.importNode($('#rowTpl').content,true);
    $('.name',row).textContent=item.name;
    $('.id',row).textContent=item.id;
    const {paid,remain}=calc(item);
    $('.initial',row).textContent=fmt(item.initial,state.data.currency);
    $('.paid',row).textContent=fmt(paid,state.data.currency);
    $('.remain',row).textContent=fmt(remain,state.data.currency);
    $('.editBtn',row).onclick=()=>edit(item.id);
    $('.payBtn',row).onclick=()=>pay(item.id);
    tb.appendChild(row);
  });
}

function addPerson(){
  const n=prompt('Name?'); if(!n) return;
  const init=parseFloat(prompt('Initial amount?','0'))||0;
  state.data.items.push({id:uid(),name:n,initial:init,paid:[]});
  save('Add person '+n); render();
}

function edit(id){
  const it=state.data.items.find(x=>x.id===id); if(!it) return;
  const n=prompt('Name:',it.name); if(!n) return;
  const init=parseFloat(prompt('Initial amount:',it.initial))||0;
  it.name=n; it.initial=init; save('Edit '+n); render();
}

function pay(id){
  const it=state.data.items.find(x=>x.id===id); if(!it) return;
  const amt=parseFloat(prompt('Payment?','0'))||0; if(!amt) return;
  const note=prompt('Note:','')||'';
  it.paid.push({amount:amt,date:new Date().toISOString(),by:state.yourName,note});
  save('Payment '+it.name+' '+amt); render();
}

$('#addPersonBtn').onclick=()=>addPerson();
$('#refreshBtn').onclick=()=>connect();
$('#connectBtn').onclick=()=>connect();
</script>
</body>
</html>
